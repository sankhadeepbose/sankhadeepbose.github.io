  <!-- Monolithic Citation.js (includes BibTeX + CSL plugins) -->
  <script src="https://cdn.jsdelivr.net/npm/citation-js@0.7.18/build/citation.min.js"></script>

  <script>
    const Cite = window.Cite;
    if (!Cite) {
      console.error('Citation.js did not load correctly.');
    }

    // Load and register ACS CSL style; if that fails, fall back to APS (physics).
    let acsTemplateLoaded = false;
    async function ensureACSTemplate () {
      if (acsTemplateLoaded) return;

      const config = Cite.plugins.config.get('csl');

      // If already registered under 'acs', skip fetching
      try {
        if (config.templates.has && config.templates.has('acs')) {
          acsTemplateLoaded = true;
          return;
        }
      } catch (e) {
        // older API: just proceed to load
      }

      try {
        // Primary: ACS style
        const res = await fetch('https://www.zotero.org/styles/american-chemical-society');
        if (!res.ok) {
          throw new Error('Failed to fetch ACS CSL style: ' + res.status);
        }
        const style = await res.text();
        config.templates.add('acs', style);
        acsTemplateLoaded = true;
      } catch (e) {
        console.warn('Failed to load ACS style, falling back to APS (physics):', e);
        // Fallback: APS physics style
        const res2 = await fetch('https://www.zotero.org/styles/american-physical-society');
        if (!res2.ok) {
          throw new Error('Failed to fetch APS fallback style: ' + res2.status);
        }
        const style2 = await res2.text();
        // Still register under 'acs' so the rest of the code can use template: "acs"
        config.templates.add('acs', style2);
        acsTemplateLoaded = true;
      }
    }

    // Very simple BibTeX field parser (works for your clean entries)
    function parseBibFields (entry) {
      const fields = {};
      const bodyStart = entry.indexOf('{');
      if (bodyStart === -1) return fields;
      const body = entry.slice(bodyStart + 1);
      const lines = body.split(/\n/);

      for (let line of lines) {
        line = line.trim();
        if (line.startsWith('}')) break;
        const m = line.match(/^([A-Za-z]+)\s*=\s*[{"](.+?)[}"],?\s*$/);
        if (m) {
          const key = m[1].toLowerCase();
          const value = m[2].trim();
          fields[key] = value;
        }
      }
      return fields;
    }

    // Map BibTeX month to numeric month
    function parseMonth (monthRaw) {
      if (!monthRaw) return 0;
      const mNum = parseInt(monthRaw, 10);
      if (!isNaN(mNum)) return mNum;

      const short = monthRaw.toLowerCase().slice(0, 3);
      const map = {
        jan: 1, feb: 2, mar: 3, apr: 4, may: 5, jun: 6,
        jul: 7, aug: 8, sep: 9, oct: 10, nov: 11, dec: 12
      };
      return map[short] || 0;
    }

    // Extract BibTeX key from entry
    function extractBibKey (entry) {
      const m = entry.match(/^@\w+\s*\{\s*([^,]+),/);
      return m ? m[1].trim() : 'entry';
    }

    async function loadPublications () {
      const container = document.getElementById('pub-list');

      try {
        await ensureACSTemplate();

        const response = await fetch('publications.bib');
        if (!response.ok) {
          throw new Error('Network response was not ok (status ' + response.status + ')');
        }

        let bibText = await response.text();

        // Remove comment lines starting with '%' and trim
        bibText = bibText.replace(/^\s*%.*$/gm, '').trim();
        if (!bibText) {
          throw new Error('BibTeX file is empty after removing comments.');
        }

        // Split into entries on newline + '@'
        const rawEntries = bibText.split(/\n@/).filter(e => e.trim());
        const entries = rawEntries.map(entry => {
          const trimmed = entry.trim();
          return trimmed.startsWith('@') ? trimmed : '@' + trimmed;
        });

        const categories = { peer: [], thesis: [] };

        entries.forEach(entry => {
          const typeMatch = entry.match(/^@(\w+)/i);
          const type = typeMatch ? typeMatch[1].toLowerCase() : '';
          const fields = parseBibFields(entry);
          const year = fields.year ? parseInt(fields.year, 10) : 0;
          const month = parseMonth(fields.month);

          const item = { entry, fields, year, month };

          if (type === 'article') {
            categories.peer.push(item);
          } else if (type.includes('thesis')) {
            categories.thesis.push(item);
          } else {
            categories.peer.push(item); // fallback
          }
        });

        // Sort by year desc, then month desc
        const sortDesc = (a, b) => {
          if (b.year !== a.year) return b.year - a.year;
          return b.month - a.month;
        };
        categories.peer.sort(sortDesc);
        categories.thesis.sort(sortDesc);

        // Clear existing content
        container.innerHTML = '';

        // Helper to render a category list
        const renderList = (items, headingText) => {
          if (!items.length) return;

          const h3 = document.createElement('h3');
          h3.textContent = headingText;
          container.appendChild(h3);

          const ol = document.createElement('ol');
          ol.setAttribute('reversed', '');
          ol.start = items.length;

          items.forEach(item => {
            const { entry, fields } = item;

            // Format citation using ACS (or APS fallback) style
            const cite = new Cite(entry);
            const html = cite.format('bibliography', {
              format: 'html',
              template: 'acs',
              lang: 'en-US'
            });

            const temp = document.createElement('div');
            temp.innerHTML = html;
            const cslEntry = temp.querySelector('.csl-entry') || temp;

            const li = document.createElement('li');
            li.innerHTML = cslEntry.innerHTML;

            // --- Buttons under each entry: PDF, Article page, BibTeX ---
            const linksDiv = document.createElement('div');
            linksDiv.className = 'pub-links';

            // PDF: prefer eprint, then URL/doi
            const pdfUrl =
              fields.eprint ||
              fields.url ||
              fields.URL ||
              (fields.doi ? ('https://doi.org/' + fields.doi) : '');

            if (pdfUrl) {
              const aPdf = document.createElement('a');
              aPdf.textContent = 'PDF';
              aPdf.href = pdfUrl;
              aPdf.target = '_blank';
              aPdf.rel = 'noopener';
              aPdf.className = 'pub-btn';
              linksDiv.appendChild(aPdf);
            }

            // Article page: main URL or DOI
            const webUrl =
              fields.url ||
              fields.URL ||
              (fields.doi ? ('https://doi.org/' + fields.doi) : '');

            if (webUrl) {
              const aWeb = document.createElement('a');
              aWeb.textContent = 'Article page';
              aWeb.href = webUrl;
              aWeb.target = '_blank';
              aWeb.rel = 'noopener';
              aWeb.className = 'pub-btn';
              linksDiv.appendChild(aWeb);
            }

            // BibTeX download for this entry
            const key = extractBibKey(entry);
            const aBib = document.createElement('a');
            aBib.textContent = 'BibTeX';
            aBib.className = 'pub-btn';
            const bibContent = entry.trim() + '\n';
            aBib.href = 'data:text/plain;charset=utf-8,' +
                        encodeURIComponent(bibContent);
            aBib.download = key + '.bib';
            linksDiv.appendChild(aBib);

            li.appendChild(linksDiv);
            ol.appendChild(li);
          });

          container.appendChild(ol);
        };

        renderList(categories.peer, 'In Peer-Reviewed Journals');
        renderList(categories.thesis, 'Theses');
      } catch (err) {
        console.error('Failed to load publications:', err);
        container.textContent = 'Unable to load publications. Please check your .bib file.';
      }
    }

    document.addEventListener('DOMContentLoaded', loadPublications);
  </script>
</body>
</html>
